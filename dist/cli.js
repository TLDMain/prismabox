#!/usr/bin/env node
"use strict";var D=require("node:fs/promises"),ge=require("@prisma/generator-helper");var u=require("@sinclair/typebox"),N=require("@sinclair/typebox/value"),O=u.Type.Object({output:u.Type.String({default:"./prisma/prismabox"}),typeboxImportVariableName:u.Type.String({default:"Type"}),typeboxImportDependencyName:u.Type.String({default:"@sinclair/typebox"}),additionalProperties:u.Type.Boolean({default:!1}),inputModel:u.Type.Boolean({default:!1}),ignoreIdOnInputModel:u.Type.Boolean({default:!0}),ignoreCreatedAtOnInputModel:u.Type.Boolean({default:!0}),ignoreUpdatedAtOnInputModel:u.Type.Boolean({default:!0}),nullableName:u.Type.String({default:"__nullable__"}),allowRecursion:u.Type.Boolean({default:!0}),additionalFieldsPlain:u.Type.Optional(u.Type.Array(u.Type.String())),transformDateName:u.Type.String({default:"__transformDate__"}),useJsonTypes:u.Type.Union([u.Type.Boolean(),u.Type.Literal("transformer")],{default:!1}),importFileExtension:u.Type.String({default:""}),exportedTypePrefix:u.Type.String({default:""})},{additionalProperties:!1}),B={};function G(e){try{N.Value.Clean(O,e),N.Value.Default(O,e),B=N.Value.Decode(O,N.Value.Convert(O,e)),Object.freeze(B)}catch(t){throw console.error(N.Value.Errors(O,e).First),t}}function o(){return B}function Q(e){return e.type==="OPTIONS"}var Ie=[{type:"HIDDEN_INPUT_CREATE",keys:["@prismabox.create.input.hide","@prismabox.create.input.hidden"]},{type:"HIDDEN_INPUT_UPDATE",keys:["@prismabox.update.input.hide","@prismabox.update.input.hidden"]},{type:"HIDDEN_INPUT",keys:["@prismabox.input.hide","@prismabox.input.hidden"]},{type:"HIDDEN",keys:["@prismabox.hide","@prismabox.hidden"]},{type:"OPTIONS",keys:["@prismabox.options"]}];function d(e){let t=[],n="",p=e??"";for(let i of p.split(`
`).map(r=>r.trim()).filter(r=>r.length>0)){let r=Ie.find(a=>a.keys.some(m=>i.startsWith(m)));if(r)if(r.type==="OPTIONS"){if(!i.startsWith(`${r.keys[0]}{`))throw new Error("Invalid syntax, expected opening { after prismabox.options");if(!i.endsWith("}"))throw new Error("Invalid syntax, expected closing } for prismabox.options");t.push({type:"OPTIONS",value:i.substring(r.keys[0].length+1,i.length-1)})}else t.push({type:r.type});else n+=`${i}
`}return n=n.trim(),{annotations:t,description:n.length>0?n:void 0,isHidden:Me(t),isHiddenInput:Pe(t),isHiddenInputCreate:Ne(t),isHiddenInputUpdate:De(t)}}function Me(e){return e.some(t=>t.type==="HIDDEN")}function Pe(e){return e.some(t=>t.type==="HIDDEN_INPUT")}function Ne(e){return e.some(t=>t.type==="HIDDEN_INPUT_CREATE")}function De(e){return e.some(t=>t.type==="HIDDEN_INPUT_UPDATE")}function s({input:e,exludeAdditionalProperties:t=!1}={}){let n=[];for(let p of e?.annotations??[])Q(p)&&n.push(p.value);return t||n.push(`additionalProperties: ${o().additionalProperties}`),e?.description&&n.push(`description: \`${e.description}\``),n.length>0?`{${n.join(",")}}`:""}function x(e,t=s({exludeAdditionalProperties:!0})){return`${o().typeboxImportVariableName}.Union([${e.join(",")}], ${t})
`}var f=[];function X(e){for(let t of e){let n=Oe(t);n&&f.push({name:t.name,stringRepresentation:n})}Object.freeze(f)}function Oe(e){let t=d(e.documentation);if(t.isHidden)return;let n=e.values.map(p=>`${o().typeboxImportVariableName}.Literal('${p.name}')`);return x(n,s({input:t}))}var Te=["Int","BigInt","Float","Decimal","String","DateTime","Json","Boolean","Bytes"];function b(e){return Te.includes(e)}function I({fieldType:e,options:t}){if(["Int","BigInt"].includes(e))return`${o().typeboxImportVariableName}.Integer(${t})`;if(["Float","Decimal"].includes(e))return`${o().typeboxImportVariableName}.Number(${t})`;if(e==="String")return`${o().typeboxImportVariableName}.String(${t})`;if(["DateTime"].includes(e)){let n=o();if(n.useJsonTypes==="transformer")return`${o().transformDateName}(${t})`;if(n.useJsonTypes){let p=t;return p.includes("{")&&p.includes("}")?p=p.replace("{","{ format: 'date-time', "):p="{ format: 'date-time' }",`${n.typeboxImportVariableName}.String(${p})`}return`${o().typeboxImportVariableName}.Date(${t})`}if(e==="Json")return`${o().typeboxImportVariableName}.Any(${t})`;if(e==="Boolean")return`${o().typeboxImportVariableName}.Boolean(${t})`;if(e==="Bytes")return`${o().typeboxImportVariableName}.Uint8Array(${t})`;throw new Error("Invalid type for primitive generation")}function y(e,t=!1){return`${o().typeboxImportVariableName}.Partial(${e}, ${s({exludeAdditionalProperties:t})})`}var H=[];function Y(e){for(let t of e){let n=he(t);n&&H.push({name:t.name,stringRepresentation:n})}Object.freeze(H)}function he(e){let t=d(e.documentation);if(t.isHidden)return;let n=e.fields.map(i=>{if(!d(i.documentation).isHidden&&!b(i.type))return`${i.name}: ${o().typeboxImportVariableName}.Boolean()`}).filter(i=>i);n.push(`_count: ${o().typeboxImportVariableName}.Boolean()`);let p=`${o().typeboxImportVariableName}.Object({${[...n].join(",")}},${s({input:t})})
`;return y(p)}var A=[];function Z(e){for(let t of e){let n=Fe(t);n&&A.push({name:t.name,stringRepresentation:n})}Object.freeze(A)}function Fe(e){let t=d(e.documentation);if(t.isHidden)return;let n=e.fields.map(i=>{if(!d(i.documentation).isHidden&&b(i.type))return`${i.name}: ${x([`${o().typeboxImportVariableName}.Literal('asc')`,`${o().typeboxImportVariableName}.Literal('desc')`])}`}).filter(i=>i),p=`${o().typeboxImportVariableName}.Object({${[...n].join(",")}},${s({input:t})})
`;return y(p)}function $(e){return`${o().typeboxImportVariableName}.Array(${e}, ${s({exludeAdditionalProperties:!0})})`}function ee(){return`import { ${o().typeboxImportVariableName}, type TSchema } from "${o().typeboxImportDependencyName}"
export const ${o().nullableName} = <T extends TSchema>(schema: T) => ${o().typeboxImportVariableName}.Union([${o().typeboxImportVariableName}.Null(), schema])
`}function te(){return`import { ${o().nullableName} } from "./${o().nullableName}${o().importFileExtension}"
`}function j(e){return`${o().nullableName}(${e})`}function q(e){return`${o().typeboxImportVariableName}.Optional(${e})`}var M=[];function ne(e){for(let t of e){let n=T(t);n&&M.push({name:t.name,stringRepresentation:n})}Object.freeze(M)}function T(e,t=!1,n=!1){let p=d(e.documentation);if(p.isHidden||(t||n)&&p.isHiddenInput||t&&p.isHiddenInputCreate||n&&p.isHiddenInputUpdate)return;let i=e.fields.map(r=>{let a=d(r.documentation);if(a.isHidden||(t||n)&&a.isHiddenInput||t&&a.isHiddenInputCreate||n&&a.isHiddenInputUpdate||o().ignoreIdOnInputModel&&(t||n)&&r.isId||o().ignoreCreatedAtOnInputModel&&(t||n)&&r.name==="createdAt"&&r.hasDefaultValue||o().ignoreUpdatedAtOnInputModel&&(t||n)&&r.isUpdatedAt||(t||n)&&(r.name.toLowerCase().endsWith("id")||r.name.toLowerCase().endsWith("foreign")||r.name.toLowerCase().endsWith("foreignkey")))return;let m="";if(b(r.type))m=I({fieldType:r.type,options:s({input:a,exludeAdditionalProperties:!0})});else if(f.find(c=>c.name===r.type))m=f.find(c=>c.name===r.type).stringRepresentation;else return;r.isList&&(m=$(m));let l=!1;return r.isRequired||(m=j(m),t&&(m=q(m),l=!0)),!l&&r.hasDefaultValue&&(t||n)&&(m=q(m),l=!0),`${r.name}: ${m}`}).filter(r=>r);return`${o().typeboxImportVariableName}.Object({${[...i,t||n?[]:o().additionalFieldsPlain??[]].join(",")}},${s({input:p})})
`}var E=[];function oe(e){for(let t of e){let n=T(t,!0,!1);n&&E.push({name:t.name,stringRepresentation:n})}Object.freeze(E)}var U=[];function re(e){for(let t of e){let n=T(t,!1,!0);n&&U.push({name:t.name,stringRepresentation:n})}Object.freeze(U)}var h=[];function ie(e){for(let t of e){let n=Re(t);n&&h.push({name:t.name,stringRepresentation:n})}Object.freeze(h)}function Re(e){let t=d(e.documentation);if(t.isHidden)return;let n=e.fields.map(p=>{if(d(p.documentation).isHidden||b(p.type)||f.find(a=>a.name===p.type))return;let r=M.find(a=>a.name===p.type)?.stringRepresentation;if(r)return p.isList&&(r=$(r)),p.isRequired||(r=j(r)),`${p.name}: ${r}`}).filter(p=>p);return`${o().typeboxImportVariableName}.Object({${n.join(",")}},${s({input:t})})
`}var F=[];function ae(e){for(let t of e){let n=Ve(t,e);n&&F.push({name:t.name,stringRepresentation:n})}Object.freeze(F)}function Ve(e,t){let n=d(e.documentation);if(n.isHidden||n.isHiddenInput||n.isHiddenInputCreate)return;let p=e.fields.map(i=>{let r=d(i.documentation);if(r.isHidden||r.isHiddenInput||r.isHiddenInputCreate||b(i.type)||f.find(c=>c.name===i.type))return;let a="String";switch(t.find(c=>c.name===i.type)?.fields.find(c=>c.isId)?.type){case"String":a="String";break;case"Int":a="Integer";break;case"BigInt":a="Integer";break;default:throw new Error("Unsupported id type")}let m=`${o().typeboxImportVariableName}.Object({
				id: ${o().typeboxImportVariableName}.${a}(${s({input:r})}),
			},${s({input:r})})`;i.isList&&(m=$(m));let l=`${o().typeboxImportVariableName}.Object({
				connect: ${m},
			}, ${s()})`;return(!i.isRequired||i.isList)&&(l=`${o().typeboxImportVariableName}.Optional(${l})`),`${i.name}: ${l}`}).filter(i=>i);return`${o().typeboxImportVariableName}.Object({${p.join(",")}},${s({input:n})})
`}var R=[];function pe(e){for(let t of e){let n=He(t,e);n&&R.push({name:t.name,stringRepresentation:n})}Object.freeze(R)}function He(e,t){let n=d(e.documentation);if(n.isHidden||n.isHiddenInput||n.isHiddenInputUpdate)return;let p=e.fields.map(i=>{let r=d(i.documentation);if(r.isHidden||r.isHiddenInput||r.isHiddenInputUpdate||b(i.type)||f.find(l=>l.name===i.type))return;let a="String";switch(t.find(l=>l.name===i.type)?.fields.find(l=>l.isId)?.type){case"String":a="String";break;case"Int":a="Integer";break;case"BigInt":a="Integer";break;default:throw new Error("Unsupported id type")}let m;return i.isList?m=y(`${o().typeboxImportVariableName}.Object({
						connect: ${$(`${o().typeboxImportVariableName}.Object({
								id: ${o().typeboxImportVariableName}.${a}(${s({input:r})})
							}, ${s({input:r})})`)},
						disconnect: ${$(`${o().typeboxImportVariableName}.Object({
								id: ${o().typeboxImportVariableName}.${a}(${s({input:r})})
							}, ${s({input:r})})`)}
					}, ${s({input:r})})`):i.isRequired?m=`${o().typeboxImportVariableName}.Object({
						connect: ${o().typeboxImportVariableName}.Object({
							id: ${o().typeboxImportVariableName}.${a}(${s({input:r})})
						}, ${s({input:r})})
					}, ${s({input:r})})`:m=y(`${o().typeboxImportVariableName}.Object({
						connect: ${o().typeboxImportVariableName}.Object({
							id: ${o().typeboxImportVariableName}.${a}(${s({input:r})})
						}, ${s({input:r})}),
						disconnect: ${o().typeboxImportVariableName}.Boolean()
					}, ${s({input:r})})`),`${i.name}: ${m}`}).filter(i=>i);return y(`${o().typeboxImportVariableName}.Object({${p.join(",")}},${s({input:n})})`)}var v=[];function se(e){for(let t of e){let n=Ae(t);n&&v.push({name:t.name,stringRepresentation:n})}Object.freeze(v)}function Ae(e){let t=d(e.documentation);if(t.isHidden)return;let n=e.fields.map(i=>{if(!d(i.documentation).isHidden)return`${i.name}: ${o().typeboxImportVariableName}.Boolean()`}).filter(i=>i);n.push(`_count: ${o().typeboxImportVariableName}.Boolean()`);let p=`${o().typeboxImportVariableName}.Object({${[...n].join(",")}},${s({input:t})})
`;return y(p)}function L(e,t=s({exludeAdditionalProperties:!0})){return`${o().typeboxImportVariableName}.Intersect([${e.join(",")}], ${t})
`}var P="Self",C=[];function me(e){for(let t of e){let n=je(t);n&&C.push({name:t.name,stringRepresentation:n})}Object.freeze(C)}function je(e){let t=d(e.documentation);if(t.isHidden)return;let n=e.fields.map(p=>{let i=d(p.documentation);if(i.isHidden)return;let r="";if(b(p.type))r=I({fieldType:p.type,options:s({exludeAdditionalProperties:!0,input:i})});else if(f.find(a=>a.name===p.type))r=f.find(a=>a.name===p.type).stringRepresentation;else return;return p.isList&&(r=$(r)),`${p.name}: ${r}`}).filter(p=>p);return o().allowRecursion?y(`${o().typeboxImportVariableName}.Recursive(${P} =>${o().typeboxImportVariableName}.Object({${le()},${n.join(",")}},${s({exludeAdditionalProperties:!0,input:t})}), { $id: "${e.name}"})`):y(`${o().typeboxImportVariableName}.Object({${n.join(",")}},${s({exludeAdditionalProperties:!0,input:t})})`)}var w=[];function de(e){for(let t of e){let n=Ee(t);n&&w.push({name:t.name,stringRepresentation:n})}Object.freeze(w)}function Ee(e){let t=d(e.documentation);if(t.isHidden)return;let n=e.uniqueFields.map(a=>{let m=a.join("_"),c=a.map(g=>e.fields.find(V=>V.name===g)).map(g=>{let V=d(g.documentation);if(V.isHidden)return;let W="";if(b(g.type))W=I({fieldType:g.type,options:s({exludeAdditionalProperties:!0,input:V})});else if(f.find(k=>k.name===g.type))W=f.find(k=>k.name===g.type).stringRepresentation;else throw new Error("Invalid type for unique composite generation");return`${g.name}: ${W}`}),xe=`${o().typeboxImportVariableName}.Object({${c.join(",")}}, ${s({exludeAdditionalProperties:!0})})`;return`${m}: ${xe}`}),p=e.fields.map(a=>{let m=d(a.documentation);if(m.isHidden)return;let l="";if(b(a.type))l=I({fieldType:a.type,options:s({exludeAdditionalProperties:!0,input:m})});else if(f.find(c=>c.name===a.type))l=f.find(c=>c.name===a.type).stringRepresentation;else return;return a.isList&&(l=$(l)),`${a.name}: ${l}`}).filter(a=>a),i=e.fields.map(a=>{let m=d(a.documentation);if(m.isHidden||!a.isUnique&&!a.isId)return;let l="";if(b(a.type))l=I({fieldType:a.type,options:s({exludeAdditionalProperties:!0,input:m})});else if(f.find(c=>c.name===a.type))l=f.find(c=>c.name===a.type).stringRepresentation;else return;return a.isList&&(l=$(l)),`${a.name}: ${l}`}).filter(a=>a),r=`${o().typeboxImportVariableName}.Object({${[...i,...n].join(",")}},${s({exludeAdditionalProperties:!0,input:t})})`;return o().allowRecursion?`${o().typeboxImportVariableName}.Recursive(${P} => ${L([y(r,!0),x([...i,...n].map(a=>`${o().typeboxImportVariableName}.Object({${a}})`)),y(`${o().typeboxImportVariableName}.Object({${le()}})`,!0),y(`${o().typeboxImportVariableName}.Object({${p.join(",")}}, ${s()})`)])}, { $id: "${e.name}"})`:L([y(r,!0),x([...i,...n].map(a=>`${o().typeboxImportVariableName}.Object({${a}})`)),y(`${o().typeboxImportVariableName}.Object({${p.join(",")}})`)])}function le(){return`AND: ${o().typeboxImportVariableName}.Union([${P}, ${$(P)}]),
	NOT: ${o().typeboxImportVariableName}.Union([${P}, ${$(P)}]),
	OR: ${$(P)}`}var J=require("node:fs/promises"),K=require("node:path");function ue(e){return e.map(t=>`export * from "./${t}${o().importFileExtension}";`).join(`
`)}var fe=require("prettier");async function z(e){try{return await(0,fe.format)(e,{parser:"typescript"})}catch(t){return console.error("Error formatting file",t),e}}function ce(){return`import { type StringOptions, ${o().typeboxImportVariableName} } from "${o().typeboxImportDependencyName}";
  export const ${o().transformDateName} = (options?: StringOptions) => ${o().typeboxImportVariableName}.Transform(${o().typeboxImportVariableName}.String({ format: 'date-time', ...options }))
   .Decode((value) => new Date(value))
   .Encode((value) => value.toISOString())
`}function ye(){return`import { ${o().transformDateName} } from "./${o().transformDateName}${o().importFileExtension}"
`}function S(e){return`${o().typeboxImportVariableName}.Composite([${e.map(t=>`${o().exportedTypePrefix}${t}`).join(",")}], ${s()})
`}function _(e){return`export const ${o().exportedTypePrefix}${e.name} = ${e.stringRepresentation}
`}function Ue(){return`import { ${o().typeboxImportVariableName} } from "${o().typeboxImportDependencyName}"
`}function be(){let e=new Map,t=(n,p)=>{for(let i of n){let r=_({...i,name:`${i.name}${p}`}),a=e.get(i.name);a?e.set(i.name,`${a}
${r}`):e.set(i.name,r)}};t(f,""),t(M,"Plain"),t(h,"Relations"),t(E,"PlainInputCreate"),t(U,"PlainInputUpdate"),t(F,"RelationsInputCreate"),t(R,"RelationsInputUpdate"),t(C,"Where"),t(w,"WhereUnique"),t(v,"Select"),t(H,"Include"),t(A,"OrderBy");for(let[n,p]of e){let i=M.find(m=>m.name===n),r=h.find(m=>m.name===n),a;if(i&&r)a=S([`${n}Plain`,`${n}Relations`]);else if(i)a=`${n}Plain`;else if(r)a=`${n}Relations`;else continue;e.set(n,`${p}
${_({name:n,stringRepresentation:a})}`)}for(let[n,p]of e)if(F.find(r=>r.name===n)){let r=S([`${n}PlainInputCreate`,`${n}RelationsInputCreate`]);e.set(n,`${p}
${_({name:`${n}InputCreate`,stringRepresentation:r})}`)}for(let[n,p]of e)if(R.find(r=>r.name===n)){let r=S([`${n}PlainInputUpdate`,`${n}RelationsInputUpdate`]);e.set(n,`${p}
${_({name:`${n}InputUpdate`,stringRepresentation:r})}`)}for(let[n,p]of e)e.set(n,`${Ue()}
${ye()}
${te()}
${p}`);return e.set(o().nullableName,ee()),e.set(o().transformDateName,ce()),e}async function $e(){let e=Array.from(be().entries());return Promise.all([...e.map(async([t,n])=>(0,J.writeFile)((0,K.join)(o().output,`${t}.ts`),await z(n))),(0,J.writeFile)((0,K.join)(o().output,"barrel.ts"),await z(ue(e.map(([t])=>t))))])}(0,ge.generatorHandler)({onManifest(){return{defaultOutput:"./prismabox",prettyName:"prismabox"}},async onGenerate(e){G({...e.generator.config,output:e.generator.output?.value});try{await(0,D.access)(o().output),await(0,D.rm)(o().output,{recursive:!0})}catch{}await(0,D.mkdir)(o().output,{recursive:!0}),X(e.dmmf.datamodel.enums),ne(e.dmmf.datamodel.models),ie(e.dmmf.datamodel.models),me(e.dmmf.datamodel.models),de(e.dmmf.datamodel.models),o().inputModel&&(oe(e.dmmf.datamodel.models),re(e.dmmf.datamodel.models),ae(e.dmmf.datamodel.models),pe(e.dmmf.datamodel.models)),se(e.dmmf.datamodel.models),Y(e.dmmf.datamodel.models),Z(e.dmmf.datamodel.models),await $e()}});
